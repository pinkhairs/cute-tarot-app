<script>
  import { Preferences } from '@capacitor/preferences';
  import { createEventDispatcher } from 'svelte';
  import { onMount } from 'svelte';
  import fetchData from '@/src/fetchData.js';
  import { loading, user } from '@/src/store.js';
  import { get } from 'svelte/store';

  const dispatch = createEventDispatcher();
  let deck = 'Spoopy Tarot';

  async function toggleDeck() {
    loading.set(true);
    deck = deck === "Spoopy Tarot" ? "Kawaii Tarot" : "Spoopy Tarot";
    if ($user) {
      await fetchData('usermeta', { name: 'deck', value: deck }, 'POST');
    }
    
    await Preferences.set({
      key: 'deck',
      value: deck
    });
    window.ls('track', {
      event: 'Switch to '+deck,
      channel: 'preferences',
      icon: '🃏',
    });
    dispatch('deckChange', { deck });
    loading.set(false);
  }

  async function loadInitialDeck() {
    const { value } = await Preferences.get({ key: 'deck' });
    deck = value || "Spoopy Tarot";
    dispatch('deckChange', { deck });
  }

  onMount(() => {
    loadInitialDeck();
  });
</script>

<button class="flex h-full items-center justify-center" on:click={toggleDeck}>
  {#if deck === "Spoopy Tarot"}
  <svg width="35" height="32" viewBox="0 0 35 32" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M14.8678 30.959C13.4758 31.343 11.9367 31.1906 10.5874 30.4116C9.21195 29.6174 8.30251 28.3283 7.95341 26.8993C3.82657 24.9007 0.642578 21.3016 0.642578 16.0532C0.642578 11.8917 2.70305 7.88805 5.71834 4.98564C8.76434 2.05367 13.0288 0 17.8192 0C22.6096 0 26.8741 2.05367 29.9201 4.98564C32.9354 7.88805 34.9958 11.8917 34.9958 16.0532C34.9958 21.0614 32.0858 24.5833 28.2219 26.6291C27.9257 28.1649 26.9899 29.568 25.5287 30.4116C24.2069 31.1747 22.703 31.3365 21.3336 30.9818C20.424 31.6233 19.3144 32 18.1168 32C16.905 32 15.7833 31.6143 14.8678 30.959ZM14.3215 17.6471C14.3215 19.0116 13.2153 20.1177 11.8509 20.1177C10.4864 20.1177 9.38025 19.0116 9.38025 17.6471C9.38025 16.2826 10.4864 15.1765 11.8509 15.1765C13.2153 15.1765 14.3215 16.2826 14.3215 17.6471ZM17.7211 21.6792C17.2149 22.1984 16.3845 22.2285 15.8417 21.7384C15.2857 21.2364 15.2419 20.3788 15.7439 19.8228L16.8844 18.5595C17.3864 18.0035 18.244 17.9597 18.8 18.4617C18.9098 18.5608 18.9996 18.6739 19.0692 18.7957C19.0889 18.8217 19.1077 18.8487 19.1257 18.8765L19.8985 20.0699C20.3056 20.6986 20.1259 21.5384 19.4971 21.9455C18.916 22.3219 18.1545 22.1968 17.7211 21.6792ZM23.6198 20.1177C24.9843 20.1177 26.0904 19.0116 26.0904 17.6471C26.0904 16.2826 24.9843 15.1765 23.6198 15.1765C22.2553 15.1765 21.1492 16.2826 21.1492 17.6471C21.1492 19.0116 22.2553 20.1177 23.6198 20.1177ZM4.17202 16.0532C4.17202 13.0437 5.68968 9.91208 8.16598 7.52847C10.6401 5.14698 14.054 3.52944 17.8192 3.52944C21.5844 3.52944 24.9983 5.14698 27.4724 7.52847C29.9487 9.91208 31.4664 13.0437 31.4664 16.0532C31.4664 20.0495 28.7837 22.8784 24.7078 24.324L24.4567 24.413L24.5761 24.6512C25.0607 25.6179 24.7128 26.8072 23.764 27.355C22.7792 27.9235 21.5201 27.5861 20.9515 26.6014L20.1756 25.2575V26.4117C20.1756 27.5488 19.2539 28.4706 18.1168 28.4706C16.9797 28.4706 16.0579 27.5488 16.0579 26.4117V25.0541L15.1646 26.6014C14.5961 27.5861 13.3369 27.9235 12.3522 27.355C11.4442 26.8308 11.0864 25.7191 11.4821 24.7772L11.5812 24.5413L11.3379 24.4623C7.03413 23.064 4.17202 20.1802 4.17202 16.0532Z" fill="currentColor"/>
  </svg>
  {:else}
  <svg width="39" height="32" viewBox="0 0 39 32" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path fill-rule="evenodd" clip-rule="evenodd" d="M21.0217 1.09743C20.6879 0.413223 19.9872 -0.0148873 19.2261 0.000396067C18.465 0.0156795 17.782 0.471574 17.476 1.16863L13.7081 9.75093L9.56091 3.23388C9.09444 2.50087 8.20005 2.16385 7.36585 2.40677C6.53166 2.64969 5.95802 3.41419 5.95802 4.28304V21.8329H2.4542C1.37493 21.8329 0.5 22.7078 0.5 23.7871C0.5 24.8664 1.37493 25.7413 2.4542 25.7413H5.95802V30.0458C5.95802 31.1251 6.83295 32 7.91222 32H30.764C31.8432 32 32.7182 31.1251 32.7182 30.0458V25.7413H36.0768C37.1561 25.7413 38.031 24.8664 38.031 23.7871C38.031 22.7078 37.1561 21.8329 36.0768 21.8329H32.7182V4.28304C32.7182 3.40223 32.1289 2.63028 31.2793 2.39801C30.4296 2.16574 29.5296 2.53057 29.0815 3.28888L25.252 9.7696L21.0217 1.09743ZM28.8098 21.8329V11.4315L26.7698 14.8836C26.404 15.5027 25.7279 15.8708 25.0094 15.8421C24.2909 15.8134 23.6463 15.3925 23.331 14.7463L19.3587 6.60289L15.8148 14.6751C15.5247 15.3357 14.8942 15.7828 14.1748 15.838C13.4554 15.8931 12.7641 15.5474 12.3767 14.9387L9.86642 10.9939V21.8329H28.8098ZM9.86642 25.7413V28.0916H28.8098V25.7413H9.86642Z" fill="currentColor"/>
    </svg>
  {/if}
</button>